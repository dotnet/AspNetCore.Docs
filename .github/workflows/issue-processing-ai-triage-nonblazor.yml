name: Issue Triage with Copilot

# =============================================================================
# TRIGGER CONFIGURATION
# This workflow runs automatically when a new issue is opened in the repository
# =============================================================================
on:
  issues:
    types:
      - opened

jobs:
  triage-non-blazor-issue:
    # ===========================================================================
    # JOB FILTER CONDITION
    # Only run this job for issues that:
    #   1. Reference ASP.NET Core documentation (must contain aspnetcore/ path)
    #   2. Are NOT related to Blazor content (excludes blazor/ folder)
    #   3. Are NOT related to Blazor-adjacent content (excludes specific 
    #      client-side interop and component tag helper docs that are 
    #      Blazor-related but located outside the blazor/ folder)
    # ===========================================================================
    if: |
      contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/')
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/blazor') 
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/client-side/dotnet-interop/index.md')
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/client-side/dotnet-interop/wasm-browser-app.md')
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/client-side/dotnet-on-webworkers.md')
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/mvc/views/tag-helpers/built-in/component-tag-helper.md')
      && !contains(github.event.issue.body, 'https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/mvc/views/tag-helpers/built-in/persist-component-state.md')
    runs-on: ubuntu-latest

    # ===========================================================================
    # PERMISSIONS
    # - issues: write    - Required to post comments and add labels to issues
    # - contents: read   - Required to checkout the repository and read agent file
    # - pull-requests: read - Required for Copilot action to access PR context that may be referred to in the issue.
    # ===========================================================================
    permissions:
      issues: write
      contents: read
      pull-requests: read

    steps:
      # =========================================================================
      # STEP 1: POST WELCOME MESSAGE
      # Immediately acknowledge the issue with a friendly welcome message
      # to let the submitter know their issue has been received
      # =========================================================================
      - name: Post welcome message
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### üëã ***Thanks for your issue!*** üòä\n\nWe will be along shortly to assist.`
            })

      # =========================================================================
      # STEP 2: CHECKOUT REPOSITORY
      # Clone the repository to access the Copilot agent configuration file
      # located at .github/agents/issue-triage-nonblazor.agent.md
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================================
      # STEP 3: RUN COPILOT AI TRIAGE
      # Execute the Copilot action with the non-Blazor triage agent to:
      #   - Analyze the issue content
      #   - Generate a triage report with recommendations
      #   - Post the analysis as a comment on the issue
      # =========================================================================
      - name: Run Copilot Issue Triage
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            try {
              // Load the existing Copilot agent instructions
              let agentInstructions;
              try {
                agentInstructions = fs.readFileSync('.github/agents/issue-triage-nonblazor.agent.md', 'utf8');
              } catch (fileError) {
                const errorMessage = `### ‚ö†Ô∏è AI Triage Error\n\nFailed to load the AI triage agent configuration file.\n\n**Error:** ${fileError.message}\n\nThe issue triage could not be completed automatically. A team member will review this issue manually.`;
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: errorMessage
                });
                throw fileError;
              }

              const issue = context.payload.issue;

              // Combine instructions and issue details into one string
              const promptLines = [
                agentInstructions,
                '',
                `Analyze issue #${issue.number} and post your triage report as a comment on the issue.`,
                `Issue URL: ${issue.html_url}`,
                '',
                'Title:',
                issue.title,
                '',
                'Body:',
                issue.body
              ];

              const prompt = promptLines.join('\n');

              // Invoke GitHub Models
              let response;
              try {
                response = await github.rest.models.runInference({
                  model: 'gpt-4.1-mini',
                  input: prompt
                });
              } catch (apiError) {
                const errorMessage = `### ‚ö†Ô∏è AI Triage Error\n\nFailed to connect to the GitHub Models API for AI analysis.\n\n**Error:** ${apiError.message}\n\nThe issue triage could not be completed automatically. A team member will review this issue manually.`;
                await github.rest.issues.createComment({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: errorMessage
                });
                throw apiError;
              }

              // Parse the response
              const choices = response.data && Array.isArray(response.data.choices) ? response.data.choices : [];
              let report = '';
              if (choices.length > 0) {
                const content = choices[0].message && Array.isArray(choices[0].message.content)
                  ? choices[0].message.content
                  : [];
                report = content
                  .filter(part => part && part.type === 'text' && typeof part.text === 'string')
                  .map(part => part.text)
                  .join('');
              }

              if (!report) {
                const errorMessage = `### ‚ö†Ô∏è AI Triage Error\n\nThe GitHub Models API returned a malformed or empty response.\n\n**Response structure:** ${JSON.stringify(response.data, null, 2)}\n\nThe issue triage could not be completed automatically. A team member will review this issue manually.`;
                await github.rest.issues.createComment({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: errorMessage
                });
                throw new Error('No triage report text returned from GitHub Models response.');
              }

              // Post the triage report
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } catch (error) {
              // Log the error and re-throw to fail the workflow
              console.error('AI triage workflow failed:', error);
              throw error;
            }

      # =========================================================================
      # STEP 4: ADD TRIAGE LABEL
      # Apply the "ai-triage-action-plan" label to indicate this issue has been
      # processed by the AI triage workflow and has an action plan generated
      # =========================================================================
      - name: Add triage label
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ["ai-triage-action-plan"]
            })
