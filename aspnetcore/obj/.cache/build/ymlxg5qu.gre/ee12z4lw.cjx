<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Custom formatters in ASP.NET Core MVC web APIs </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Custom formatters in ASP.NET Core MVC web APIs ">
    <meta name="generator" content="docfx 2.24.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="mvc/models/custom-formatters">
<h1 id="custom-formatters-in-aspnet-core-mvc-web-apis" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="15" sourceendlinenumber="15">Custom formatters in ASP.NET Core MVC web APIs</h1>

<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="17" sourceendlinenumber="17">By <a href="https://github.com/tdykstra" data-raw-source="[Tom Dykstra](https://github.com/tdykstra)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="17" sourceendlinenumber="17">Tom Dykstra</a></p>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="19" sourceendlinenumber="19">ASP.NET Core MVC has built-in support for data exchange in web APIs by using JSON, XML, or plain text formats. This article shows how to add support for additional formats by creating custom formatters.</p>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="21" sourceendlinenumber="21"><a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/advanced/custom-formatters/sample" data-raw-source="[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/advanced/custom-formatters/sample)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="21" sourceendlinenumber="21">View or download sample from GitHub</a>.</p>
<h2 id="when-to-use-custom-formatters" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="23" sourceendlinenumber="23">When to use custom formatters</h2>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="25" sourceendlinenumber="25">Use a custom formatter when you want the <a class="xref" href="../models/formatting.html" data-raw-source="[content negotiation](xref:mvc/models/formatting)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="25" sourceendlinenumber="25">content negotiation</a> process to support a content type that isn&#39;t supported by the built-in formatters (JSON, XML, and plain text).</p>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="27" sourceendlinenumber="27">For example, if some of the clients for your web API can handle the <a href="https://github.com/google/protobuf" data-raw-source="[Protobuf](https://github.com/google/protobuf)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="27" sourceendlinenumber="27">Protobuf</a> format, you might want to use Protobuf with those clients because it&#39;s more efficient.  Or you might want your web API to send contact names and addresses in <a href="https://wikipedia.org/wiki/VCard" data-raw-source="[vCard](https://wikipedia.org/wiki/VCard)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="27" sourceendlinenumber="27">vCard</a> format, a commonly used format for exchanging contact data. The sample app provided with this article implements a simple vCard formatter.</p>
<h2 id="overview-of-how-to-use-a-custom-formatter" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="29" sourceendlinenumber="29">Overview of how to use a custom formatter</h2>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="31" sourceendlinenumber="31">Here are the steps to create and use a custom formatter:</p>
<ul sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="33" sourceendlinenumber="35">
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="33" sourceendlinenumber="33">Create an output formatter class if you want to serialize data to send to the client.</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="34" sourceendlinenumber="34">Create an input formatter class if you want to deserialize data received from the client. </li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="35" sourceendlinenumber="35">Add instances of your formatters to the <code>InputFormatters</code> and <code>OutputFormatters</code> collections in <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.mvcoptions" data-raw-source="[MvcOptions](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.mvcoptions)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="35" sourceendlinenumber="35">MvcOptions</a>.</li>
</ul>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="37" sourceendlinenumber="37">The following sections provide guidance and code examples for each of these steps.</p>
<h2 id="how-to-create-a-custom-formatter-class" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="39" sourceendlinenumber="39">How to create a custom formatter class</h2>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="41" sourceendlinenumber="41">To create a formatter:</p>
<ul sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="43" sourceendlinenumber="46">
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="43" sourceendlinenumber="43">Derive the class from the appropriate base class.</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="44" sourceendlinenumber="44">Specify valid media types and encodings in the constructor.</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="45" sourceendlinenumber="45">Override <code>CanReadType</code>/<code>CanWriteType</code> methods</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="46" sourceendlinenumber="46">Override <code>ReadRequestBodyAsync</code>/<code>WriteResponseBodyAsync</code> methods</li>
</ul>
<h3 id="derive-from-the-appropriate-base-class" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="48" sourceendlinenumber="48">Derive from the appropriate base class</h3>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="50" sourceendlinenumber="50">For text media types (for example, vCard), derive from the <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.textinputformatter" data-raw-source="[TextInputFormatter](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.textinputformatter)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="50" sourceendlinenumber="50">TextInputFormatter</a> or <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.textoutputformatter" data-raw-source="[TextOutputFormatter](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.textoutputformatter)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="50" sourceendlinenumber="50">TextOutputFormatter</a> base class.</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="52" sourceendlinenumber="52"><code class="lang-csharp" name="Main">public class VcardOutputFormatter : TextOutputFormatter
</code></pre><p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="54" sourceendlinenumber="54">For binary types, derive from the <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.inputformatter" data-raw-source="[InputFormatter](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.inputformatter)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="54" sourceendlinenumber="54">InputFormatter</a> or <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.outputformatter" data-raw-source="[OutputFormatter](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.outputformatter)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="54" sourceendlinenumber="54">OutputFormatter</a> base class.</p>
<h3 id="specify-valid-media-types-and-encodings" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="56" sourceendlinenumber="56">Specify valid media types and encodings</h3>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="58" sourceendlinenumber="58">In the constructor, specify valid media types and encodings by adding to the <code>SupportedMediaTypes</code> and <code>SupportedEncodings</code> collections.</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="60" sourceendlinenumber="60"><code class="lang-csharp" name="Main" highlight-lines="3,5-6">public VcardOutputFormatter()
{
    SupportedMediaTypes.Add(MediaTypeHeaderValue.Parse(&quot;text/vcard&quot;));

    SupportedEncodings.Add(Encoding.UTF8);
    SupportedEncodings.Add(Encoding.Unicode);
}
</code></pre><div class="NOTE" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="62" sourceendlinenumber="62"><h5>Note</h5><p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="63" sourceendlinenumber="63">You can&#39;t do constructor dependency injection in a formatter class. For example, you can&#39;t get a logger by adding a logger parameter to the constructor. To access services, you have to use the context object that gets passed in to your methods. A code example <a href="#read-write" data-raw-source="[below](#read-write)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="63" sourceendlinenumber="63">below</a> shows how to do this.</p>
</div>
<h3 id="override-canreadtypecanwritetype" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="65" sourceendlinenumber="65">Override CanReadType/CanWriteType</h3>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="67" sourceendlinenumber="67">Specify the type you can deserialize into or serialize from by overriding the <code>CanReadType</code> or <code>CanWriteType</code> methods. For example, you might only be able to create vCard text from a <code>Contact</code> type and vice versa.</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="69" sourceendlinenumber="69"><code class="lang-csharp" name="Main">protected override bool CanWriteType(Type type)
{
    if (typeof(Contact).IsAssignableFrom(type) 
        || typeof(IEnumerable&lt;Contact&gt;).IsAssignableFrom(type))
    {
        return base.CanWriteType(type);
    }
    return false;
}
</code></pre><h4 id="the-canwriteresult-method" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="71" sourceendlinenumber="71">The CanWriteResult method</h4>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="73" sourceendlinenumber="73">In some scenarios you have to override <code>CanWriteResult</code> instead of <code>CanWriteType</code>. Use <code>CanWriteResult</code> if the following conditions are true:</p>
<ul sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="75" sourceendlinenumber="77">
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="75" sourceendlinenumber="75">Your action method returns a model class.</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="76" sourceendlinenumber="76">There are derived classes which might be returned at runtime.</li>
<li sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="77" sourceendlinenumber="77">You need to know at runtime which derived class was returned by the action.  </li>
</ul>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="79" sourceendlinenumber="79">For example, suppose your action method signature returns a <code>Person</code> type, but it may return a <code>Student</code> or <code>Instructor</code> type that derives from <code>Person</code>. If you want your formatter to handle only <code>Student</code> objects, check the type of <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.outputformattercanwritecontext#Microsoft_AspNetCore_Mvc_Formatters_OutputFormatterCanWriteContext_Object" data-raw-source="[Object](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.formatters.outputformattercanwritecontext#Microsoft_AspNetCore_Mvc_Formatters_OutputFormatterCanWriteContext_Object)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="79" sourceendlinenumber="79">Object</a> in the context object provided to the <code>CanWriteResult</code> method. Note that it&#39;s not necessary to use <code>CanWriteResult</code> when the action method returns <code>IActionResult</code>; in that case, the <code>CanWriteType</code> method receives the runtime type.</p>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="81" sourceendlinenumber="81"><a id="read-write"></a></p>
<h3 id="override-readrequestbodyasyncwriteresponsebodyasync" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="82" sourceendlinenumber="82">Override ReadRequestBodyAsync/WriteResponseBodyAsync</h3>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="84" sourceendlinenumber="84">You do the actual work of deserializing or serializing in <code>ReadRequestBodyAsync</code> or <code>WriteResponseBodyAsync</code>.  The highlighted lines in the following example show how to get services from the dependency injection container (you can&#39;t get them from constructor parameters).</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="86" sourceendlinenumber="86"><code class="lang-csharp" name="Main" highlight-lines="3-4">public override Task WriteResponseBodyAsync(OutputFormatterWriteContext context, Encoding selectedEncoding)
{
    IServiceProvider serviceProvider = context.HttpContext.RequestServices;
    var logger = serviceProvider.GetService(typeof(ILogger&lt;VcardOutputFormatter&gt;)) as ILogger;

    var response = context.HttpContext.Response;

    var buffer = new StringBuilder();
    if (context.Object is IEnumerable&lt;Contact&gt;)
    {
        foreach (Contact contact in context.Object as IEnumerable&lt;Contact&gt;)
        {
            FormatVcard(buffer, contact, logger);
        }
    }
    else
    {
        var contact = context.Object as Contact;
        FormatVcard(buffer, contact, logger);
    }
    return response.WriteAsync(buffer.ToString());
}

private static void FormatVcard(StringBuilder buffer, Contact contact, ILogger logger)
{
    buffer.AppendLine(&quot;BEGIN:VCARD&quot;);
    buffer.AppendLine(&quot;VERSION:2.1&quot;);
    buffer.AppendFormat($&quot;N:{contact.LastName};{contact.FirstName}\r\n&quot;);
    buffer.AppendFormat($&quot;FN:{contact.FirstName} {contact.LastName}\r\n&quot;);
    buffer.AppendFormat($&quot;UID:{contact.ID}\r\n&quot;);
    buffer.AppendLine(&quot;END:VCARD&quot;);
    logger.LogInformation($&quot;Writing {contact.FirstName} {contact.LastName}&quot;);
}
</code></pre><h2 id="how-to-configure-mvc-to-use-a-custom-formatter" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="88" sourceendlinenumber="88">How to configure MVC to use a custom formatter</h2>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="90" sourceendlinenumber="90">To use a custom formatter, add an instance of the formatter class to the <code>InputFormatters</code> or <code>OutputFormatters</code> collection.</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="92" sourceendlinenumber="92"><code class="lang-csharp" name="Main" highlight-lines="3-4">services.AddMvc(options =&gt;
{
    options.InputFormatters.Insert(0, new VcardInputFormatter());
    options.OutputFormatters.Insert(0, new VcardOutputFormatter());
});
</code></pre><p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="94" sourceendlinenumber="94">Formatters are evaluated in the order you insert them. The first one takes precedence. </p>
<h2 id="next-steps" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="96" sourceendlinenumber="96">Next steps</h2>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="98" sourceendlinenumber="98">See the <a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/advanced/custom-formatters/sample" data-raw-source="[sample application](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/advanced/custom-formatters/sample)" sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="98" sourceendlinenumber="98">sample application</a>, which implements simple vCard input and output formatters.  The application reads and writes vCards that look like the following example:</p>
<pre sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="100" sourceendlinenumber="107"><code>BEGIN:VCARD
VERSION:2.1
N:Davolio;Nancy
FN:Nancy Davolio
UID:20293482-9240-4d68-b475-325df4a83728
END:VCARD
</code></pre><p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="109" sourceendlinenumber="109">To see vCard output, run the application and send a Get request with Accept header &quot;text/vcard&quot; to <code>http://localhost:63313/api/contacts/</code> (when running from Visual Studio) or <code>http://localhost:5000/api/contacts/</code> (when running from the command line).</p>
<p sourcefile="mvc/advanced/custom-formatters.md" sourcestartlinenumber="111" sourceendlinenumber="111">To add a vCard to the in-memory collection of contacts, send a Post request to the same URL, with Content-Type header &quot;text/vcard&quot; and with vCard text in the body, formatted like the example above.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aspnet/Docs/blob/w/riande/RP-EF/aspnetcore/mvc/advanced/custom-formatters.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright Â© 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
